# TLS Notes

## WARNING

#### This guide aims to be complete and also serve as a record of creation for the actual certificates and keys that Vaultron uses. Note also that these certificates and keys are for development and experimentation only. DO NOT USE FOR ANY OTHER PURPOSE

This directory contains a set of TLS certificates and keys which were generated by the [Vault PKI Secrets Engine](https://www.vaultproject.io/docs/secrets/pki/index.html). These are the very certificates and keys which are used for end to end mutual TLS as folows:

- Consul server cluster <-> Consul client agents
- Consul client agents <-> Vault servers
- Vault server <-> Vault client

The subdirectories and their contents are organized as follows:

The Terraform templates automatically include TLS configuration for Consul and Vault in all versions from v0.9.0 on.

## Process

The certificates and keys are generated by Vault acting as both Root CA and Intermediate CA per the PKI Secrets Engine documentation.

Vaultron already enables these PKI Secrets Engine configurations:

```
$ vault secrets list | grep pki
vaultron-root-int/             pki          pki_0b742197          Vaultron example PKI secrets engine (for int CA)
vaultron-root-pki/             pki          pki_6e0c68f1          Vaultron example PKI secrets engine (for root CA)
```

So enabling those mounts beforehand is not necessary.

The steps described below are precisely taken to generate the actual certificates and keys in use by Vaultron.

## Tune The Secrets Engine Root CA Mount

Let's make it possible to issue root certificates that can last for at least 2083 days as opposed to Vault's default 30 day TTL.

Tune the Root CA secrets engine mount:

```
$ vault secrets tune \
  -max-lease-ttl=50000h \
  vaultron-root-pki
Success! Tuned the secrets engine at: vaultron-root-pki/
```

## Root CA

The following steps establish a Root CA for Vaultron.

### Root CA Certificate

Generate a CA certificate and key for the Root CA:

```
$ vault write vaultron-root-pki/root/generate/exported \
  common_name=node.arus.consul \
  ttl=50000h \
  organization="Vaultron Lab" \
  country="United States of America" \
  locality="Kittyhawk" \
  province="Outer Banks" \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="vaultron-root-ca-cert.pem"} /RSA/ {out="vaultron-root-ca-key.pem"} { print > out }'
```

### Configure URLs

```
$ vault write vaultron-root-pki/config/urls \
  issuing_certificates="http://127.0.0.1:8200/v1/pki/ca" \
  crl_distribution_points="http://127.0.0.1:8200/v1/pki/crl"
Success! Data written to: vaultron-root-pki/config/urls
```

### Configure Role

This Root CA role provides for generating certificates with a **1750 day lifespan**:

```
$ vault write vaultron-root-pki/roles/vaultron-consul-root \
  allow_localhost=true \
  allowed_domains=arus.consul,sura.consul \
  allow_subdomains=true \
  allow_bare_domains=true \
  allow_glob_domains=true \
  allow_ip_sans=true \
  generate_lease=true \
  organization="Vaultron Lab" \
  country="United States of America" \
  locality="Kittyhawk" \
  province="Outer Banks" \
  max_ttl=42000h
Success! Data written to: vaultron-root-pki/roles/vaultron-consul-root
```

### Generate Certificate from Root CA

Normally you'll want to generate certificates from the Intermediate CA and not the Root CA directly, but if you have a specific need, then using the role created above, here is an example certificate generation command:

```
$ vault write vaultron-root-pki/issue/vaultron-consul-root \
    common_name=tacotown.node.arus.consul
```

Since this is just a verification, the output is omitted.

## Intermediate CA

The following steps establish an Intermediate CA for Vaultron.

### Tune The Secrets Engine Intermediate CA Mount

Let's make it possible to issue root certificates that can last for at least **2083 days** as opposed to Vault's default 30 day TTL.

Tune the Intermediate CA secrets engine mount:

```
$ vault secrets tune \
  -max-lease-ttl=50000h \
  vaultron-int-pki
Success! Tuned the secrets engine at: vaultron-int-pki/
```

### Intermediate CA Certificate Signing Request

We generate a certificate signing request with **1750 day TTL**:

```
$ vault write \
  vaultron-int-pki/intermediate/generate/exported \
  common_name=node.arus.consul \
  ttl=42000h \
  -format=json \
  | jq -r '.data.csr + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="vaultron-int-csr.pem"} /RSA/ {out="vaultron-int-ca-key.pem"} { print > out }'
```

### Sign Intermediate CA with Root CA

We sign the Intermediate CA specifying a 1750 day TTL. This is the maximum all certificates issued from the Intermediate can have. (4.7 years)

```
$ vault write \
  vaultron-root-pki/root/sign-intermediate \
  csr=@vaultron-int-csr.pem \
  format=pem_bundle \
  ttl=42000h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.issuing_ca' \
  | awk '/CERTIFICATE/ {out="vaultron-intermediate-signed.pem"} { print > out }'
```

Now, set the intermediate certificate authority's signing certificate to the root-signed certificate:

```
$ vault write \
  vaultron-int-pki/intermediate/set-signed \
  certificate=@vaultron-intermediate-signed.pem
Success! Data written to: vaultron-int-pki/intermediate/set-signed
```

### Configure URLs

```
$ vault write \
  vaultron-int-pki/config/urls \
  issuing_certificates="http://127.0.0.1:8200/v1/pki_int/ca" \
  crl_distribution_points="http://127.0.0.1:8200/v1/pki_int/crl"
Success! Data written to: vaultron-int-pki/config/urls
```

### Configure a Role

The role has a maximum TTL of 1750 days:

```
$ vault write vaultron-int-pki/roles/vaultron-int \
  allow_subdomains=true \
  allowed_domains=arus.consul,node.arus.consul,node.sura.consul,node.consul,service.consul \
  allow_bare_domains=true \
  allow_glob_domains=true \
  allow_ip_sans=true \
  allow_localhost="true" \
  generate_lease=true \
  organization="Vaultron Lab" \
  country="United States of America" \
  locality="Kittyhawk" \
  province="Outer Banks" \
  max_ttl=42000h \
  ttl=42000h
Success! Data written to: vaultron-int-pki/roles/vaultron-int
```

#### Confirm Role

Ensure the role is correct:

```
$ vault read vaultron-int-pki/roles/vaultron-int
Key                                   Value
---                                   -----
allow_any_name                        false
allow_bare_domains                    true
allow_glob_domains                    true
allow_ip_sans                         true
allow_localhost                       true
allow_subdomains                      true
allow_token_displayname               false
allowed_domains                       [arus.consul node.arus.consul node.sura.consul node.consul service.consul]
allowed_other_sans                    <nil>
allowed_serial_numbers                []
allowed_uri_sans                      []
basic_constraints_valid_for_non_ca    false
client_flag                           true
code_signing_flag                     false
country                               [United States of America]
email_protection_flag                 false
enforce_hostnames                     true
ext_key_usage                         []
ext_key_usage_oids                    []
generate_lease                        true
key_bits                              2048
key_type                              rsa
key_usage                             [DigitalSignature KeyAgreement KeyEncipherment]
locality                              [Kittyhawk]
max_ttl                               42000h
no_store                              false
not_before_duration                   30s
organization                          [Vaultron Lab]
ou                                    []
policy_identifiers                    []
postal_code                           []
province                              [Outer Banks]
require_cn                            true
server_flag                           true
street_address                        []
ttl                                   42000h
use_csr_common_name                   true
use_csr_sans                          true
```

## Issue Certificates

Vaultron uses a private Docker network with predictable address space and we will issue a certificate per container with the loopback IP, static IP as an IP SANs value.

## Vault Servers

Let's make certificates for the Vault servers; we'll use a 19800h/825 day TTL for all of them:

```
$ vault write \
  vaultron-int-pki/issue/vaultron-int \
  common_name=vaults0.node.arus.consul \
  alt_names=active.vault.service.consul,standby.vault.service.consul,vault.service.consul,vaults0.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.200" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="vault-server-0.crt"} /RSA/ {out="vault-server-0.key"} { print > out }'
```

```
$ vault write \
  vaultron-int-pki/issue/vaultron-int \
  common_name=vaults1.node.arus.consul \
  alt_names=vaults1.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.201" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="vault-server-1.crt"} /RSA/ {out="vault-server-1.key"} { print > out }'
```

```
$ vault write \
  vaultron-int-pki/issue/vaultron-int \
  common_name=vaults2.node.arus.consul \
  alt_names=vaults2.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.202" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="vault-server-2.crt"} /RSA/ {out="vault-server-2.key"} { print > out }'
```

```
$ vault write \
  vaultron-int-pki/issue/vaultron-int \
  common_name=vaults3.node.arus.consul \
  alt_names=vaults3.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.203" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="vault-server-3.crt"} /RSA/ {out="vault-server-3.key"} { print > out }'
```

```
$ vault write \
  vaultron-int-pki/issue/vaultron-int \
  common_name=vaults4.node.arus.consul \
  alt_names=vaults4.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.204" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="vault-server-4.crt"} /RSA/ {out="vault-server-4.key"} { print > out }'
```

## Consul Servers

Let's make certificates for the Consul servers; we'll use a 19800h/825 day TTL for all of them:

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=consuls0.node.arus.consul \
  alt_names=consul.service.consul,consuls0.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.100" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="consul-server-0.crt"} /RSA/ {out="consul-server-0.key"} { print > out }'
```

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=consuls1.node.arus.consul \
  alt_names=consul.service.consul,consuls1.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.101" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="consul-server-1.crt"} /RSA/ {out="consul-server-1.key"} { print > out }'
```

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=consuls2.node.arus.consul \
  alt_names=consul.service.consul,consuls2.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.102" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="consul-server-2.crt"} /RSA/ {out="consul-server-2.key"} { print > out }'
```

## Consul Clients

Let's make certificates for the Consul clients; we'll use a 19800h/825 day TTL for all of them:

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=consulc0.node.arus.consul \
  alt_names=consul.service.consul,consulc0.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.40" \ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="consul-client-0.crt"} /RSA/ {out="consul-client-0.key"} { print > out }'
```

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=consulc1.node.arus.consul \
  alt_names=consul.service.consul,consulc1.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.41" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="consul-client-1.crt"} /RSA/ {out="consul-client-1.key"} { print > out }'
```

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=consulc2.node.arus.consul \
  alt_names=consul.service.consul,consulc2.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.42" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="consul-client-2.crt"} /RSA/ {out="consul-client-2.key"} { print > out }'
```

## Create Grafana Certificate

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=grafana.node.arus.consul \
  alt_names=grafana.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.220" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="grafana.crt"} /RSA/ {out="grafana.key"} { print > out }'
```

## Create LDAP Certificate

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=ldap.node.arus.consul \
  alt_names=ldap.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.221" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="ldap.crt"} /RSA/ {out="ldap.key"} { print > out }'
```

## Create MongoDB Certificate

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=mongodb.node.arus.consul \
  alt_names=mongodb.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.222" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="mongodb.crt"} /RSA/ {out="mongodb.key"} { print > out }'
```

## Create MySQL Certificate

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=mysql.node.arus.consul \
  alt_names=mysql.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.223" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="mysql.crt"} /RSA/ {out="mysql.key"} { print > out }'
```

## Create PostgreSQL Certificate

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=postgresql.node.arus.consul \
  alt_names=postgresql.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.224" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="postgresql.crt"} /RSA/ {out="postgresql.key"} { print > out }'
```

## Create Prometheus Certificate

```
$ vault write vaultron-int-pki/issue/vaultron-int \
  common_name=prometheus.node.arus.consul \
  alt_names=prometheus.node.consul,server.arus.consul,localhost \
  ip_sans="127.0.0.1,10.10.42.225" \
  ttl=19800h \
  -format=json \
  | jq -r '.data.certificate + "\n" + .data.private_key' \
  | awk '/CERTIFICATE/ {out="prometheus.crt"} /RSA/ {out="prometheus.key"} { print > out }'
```

## CA Certificate Chain

Take the contents of `vaultron-intermediate-signed.pem` and save as `ca.pem`:

```
-----BEGIN CERTIFICATE-----
MIIEGjCCAwKgAwIBAgIUDEaM6avTzBoPMBHyLh6ifczmBXYwDQYJKoZIhvcNAQEL
BQAwfzEhMB8GA1UEBhMYVW5pdGVkIFN0YXRlcyBvZiBBbWVyaWNhMRQwEgYDVQQI
EwtPdXRlciBCYW5rczESMBAGA1UEBxMJS2l0dHloYXdrMRUwEwYDVQQKEwxWYXVs
dHJvbiBMYWIxGTAXBgNVBAMTEG5vZGUuYXJ1cy5jb25zdWwwHhcNMjIwMjAyMTYy
MDEwWhcNMjYxMTE4MTYyMDQwWjAbMRkwFwYDVQQDExBub2RlLmFydXMuY29uc3Vs
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwaOHMEq6bylqrlmriApn
ayO+VcohXkgs3q6kZkqRnRJcAmx9LBlGk7dd2LyAt1OL629+AN50WAM69H0vFlaZ
JI1WF9eSTuswBFNkpCnn+X4l1wZ5tC140TlcQGknXBxrkBZjKYieYjFKKYKATX5d
gWLd8yC7agljFtf1WyEsxn/5CfGnnznmjHUudDKRH95SibKxmOlpZQmD9g3sIq3H
BB5ukk6phyT+Hu6SZcT/Wm0iIb2TW+W/CCuXgTekmMaO/9yp36eNanVwAgTNd9fH
BuMaOaJW4s/h24Np6I4Ec6KIEa+2YqUncKQxaPeuiasjqMd7gYbryp8gbbDWMxZX
2QIDAQABo4HxMIHuMA4GA1UdDwEB/wQEAwIBBjAPBgNVHRMBAf8EBTADAQH/MB0G
A1UdDgQWBBRH+z3oiC3wR9WXiZmh7x86uJy4FjAfBgNVHSMEGDAWgBSaL4GpXKpv
cKZR9dGpWTA5/MBV5TA7BggrBgEFBQcBAQQvMC0wKwYIKwYBBQUHMAKGH2h0dHA6
Ly8xMjcuMC4wLjE6ODIwMC92MS9wa2kvY2EwGwYDVR0RBBQwEoIQbm9kZS5hcnVz
LmNvbnN1bDAxBgNVHR8EKjAoMCagJKAihiBodHRwOi8vMTI3LjAuMC4xOjgyMDAv
djEvcGtpL2NybDANBgkqhkiG9w0BAQsFAAOCAQEAJSocJEyVBNURJJEZhf2PGjMU
sDK6+Q9M7+Uyk+C3xZMytHCJC0mOEQCtrMQDexsVNqcBBjA/qnspbPjVOETAhKJo
3+RBCC1gF2lx4hMkSaSV2muxT3DCt8LqO9MulgR9YWwYLl/9+CYIObeELvTPJUWf
pdGK3P7bJmuvFspuiKOT3s7D4F09gD1djQg+gn/vRbvm++kt1MQMoWjMVkknRXo4
aRSwo8FVVldiRm90/V3lZ+eTqvKHL/fLb4kjPFRyO761iaM+nZ68CFVox+L4mgrY
EjuJdjhyDAboz3bdfKLQRfWhTmuLw6a8JHTTpIjsHdw//WgUenC6QIBMfErh8Q==
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIEDTCCAvWgAwIBAgIUU+zAPrlHks2SCsT4KTK5eK1g4fEwDQYJKoZIhvcNAQEL
BQAwfzEhMB8GA1UEBhMYVW5pdGVkIFN0YXRlcyBvZiBBbWVyaWNhMRQwEgYDVQQI
EwtPdXRlciBCYW5rczESMBAGA1UEBxMJS2l0dHloYXdrMRUwEwYDVQQKEwxWYXVs
dHJvbiBMYWIxGTAXBgNVBAMTEG5vZGUuYXJ1cy5jb25zdWwwHhcNMjIwMjAyMTYx
OTMyWhcNMjcxMDE4MDAyMDAyWjB/MSEwHwYDVQQGExhVbml0ZWQgU3RhdGVzIG9m
IEFtZXJpY2ExFDASBgNVBAgTC091dGVyIEJhbmtzMRIwEAYDVQQHEwlLaXR0eWhh
d2sxFTATBgNVBAoTDFZhdWx0cm9uIExhYjEZMBcGA1UEAxMQbm9kZS5hcnVzLmNv
bnN1bDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAMLd39cVY1B+yraV
84Q+Wn02D9NueFUtPTIH6+SZf8y/rSsIF09kwZW0EN3iBToompHmMaGs1zP/FclU
ne+Nr+D1HQuo4p6gB7V3RzwXM91R9D3aW2eh6eQK2eJXZrMeAjGI5TXejXeIrFnh
yCaKYMySxpsvSJQGALvyLAI25JuLl4FnM3sTEY77uvjz4kzJS+hOniNP8LmqQtoa
1YKDlapJU0vp2l/nna3mV4vh3LWEZSFOc7hHY+Moe2j5hv24aDghaEc/K2f1DECf
/fBwV+4N7QjOfOqYom8WH0Te299bPhhJyCdy++JxEIIYW9U3zkoITi9FCmBW8cru
/Fxa7rMCAwEAAaOBgDB+MA4GA1UdDwEB/wQEAwIBBjAPBgNVHRMBAf8EBTADAQH/
MB0GA1UdDgQWBBSaL4GpXKpvcKZR9dGpWTA5/MBV5TAfBgNVHSMEGDAWgBSaL4Gp
XKpvcKZR9dGpWTA5/MBV5TAbBgNVHREEFDASghBub2RlLmFydXMuY29uc3VsMA0G
CSqGSIb3DQEBCwUAA4IBAQBVFNRWSWSVQuqXhdUs9eaeilg0TWEwJnEnGSzySv6Y
2fPr0dpRbKyrgQyw8Uj1iszOQBeyXG14mQNoqq7Zw1v38spq9ELWEsgNu/lrRZHN
GgnRma9goMMp4ZhPD6UF0iyUp9l3waT2siRRFPAgtIhOUuf4I89eOHbyhLWO+Omg
Xhz3STJ3O8d5RqGWVpxt99fSgMLWoCccA8yYIEGuNg8aedC9h5rPGwsGyQzzFT+1
KHLH1JtZjktC+jkNLmDtBaSGJHGSlq8HRx/VC7ptz/4lJ/JPRNFMfF6HqT8QK8vd
h4I6glLuyfomBLP37DnPozxkH6cUichYn9l4//29urgl
-----END CERTIFICATE-----
```

Use this as the value for `-ca-cert=` or `VAULT_CACERT` or import it into your OS trust store to have all of Vaultron's certificates trusted by default.

## Import into New Vault

### Root CA

Use a PEM bundle containing the certificates and key:

